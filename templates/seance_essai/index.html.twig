{# templates/seance_essai/index.html.twig #}
{% extends 'base.html.twig' %}
{% block title %}S√©ance d‚Äôessai ‚Äî Come Alive Fitness{% endblock %}

{% block body %}

<header class="hero-try">
  <div class="container reveal reveal-up">
    <h1>Votre s√©ance d‚Äôessai, offerte sur rendez-vous</h1>
    <p>D√©couvrez la salle, l‚Äôambiance et nos coachs : testez, ressentez, validez.</p>
    <div class="mt-4 d-flex justify-content-center gap-2">
      <a href="#reserver" class="btn btn-primary btn-lg"><i class="bi bi-calendar2-check me-2"></i>R√©server ma s√©ance</a>
      <a href="#comment" class="btn btn-outline-light btn-lg">Comment √ßa se passe ?</a>
    </div>
  </div>
</header>

<section class="py-5">
  <div class="container">
    <div class="row g-4 align-items-center reveal-stagger">

      <div class="col-lg-6">
        <h2 class="h1 mb-3 reveal reveal-up">Envie d‚Äôessayer avant de vous lancer ?</h2>
        <p class="text-muted">
          Come Alive Fitness vous offre une **s√©ance d‚Äôessai sur rendez-vous** pour d√©couvrir le centre, l‚Äôambiance et les coachs.
        </p>
        <div class="d-flex flex-wrap gap-2 mt-3">
          <span class="badge text-bg-primary">Encadrement coach√©</span>
          <span class="badge text-bg-success">Ambiance conviviale</span>
          <span class="badge text-bg-dark">√âquipement pro</span>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card card-hover">
          <div class="card-body d-flex align-items-center gap-3">
            <i class="bi bi-gift fs-2 text-primary"></i>
            <div>
              <div class="fw-bold">S√©ance d‚Äôessai offerte</div>
              <div class="text-muted small">Sur rendez-vous ¬∑ dans la limite des places disponibles</div>
            </div>
          </div>
          <div class="card-footer bg-transparent text-end">
            <a href="#reserver" class="btn btn-outline-primary btn-sm">Je r√©serve maintenant</a>
          </div>
        </div>
      </div>

    </div>
  </div>
</section>

<section id="comment" class="py-5 bg-body-tertiary">
  <div class="container">

    <h2 class="h1 text-center mb-5 reveal reveal-up">Comment se pr√©sente une s√©ance d‚Äôessai ?</h2>

    <div class="row g-5 reveal-stagger">

      <div class="col-lg-6">
        <div class="timeline vstack gap-4">

          <div class="timeline-item">
            <div class="timeline-bullet"></div>
            <h3 class="h5 d-flex align-items-center gap-2 mb-1"><i class="bi bi-clock-history text-primary"></i> 20 minutes avant</h3>
            <p class="text-muted mb-0">Arrivez un peu en avance pour **remplir le formulaire d‚Äôaccueil**, visiter les lieux et vous changer.</p>
          </div>

          <div class="timeline-item">
            <div class="timeline-bullet"></div>
            <h3 class="h5 d-flex align-items-center gap-2 mb-1"><i class="bi bi-activity text-danger"></i> Pendant la s√©ance</h3>
            <p class="text-muted mb-0">Participez au cours de votre choix **avec un coach** qui adaptera l‚Äôintensit√© selon votre niveau.</p>
          </div>

          <div class="timeline-item">
            <div class="timeline-bullet"></div>
            <h3 class="h5 d-flex align-items-center gap-2 mb-1"><i class="bi bi-chat-dots text-success"></i> D√©brief</h3>
            <p class="text-muted mb-0">Repassez √† l‚Äôaccueil pour un **retour d‚Äôexp√©rience** et obtenir des recommandations personnalis√©es.</p>
          </div>

        </div>
      </div>

      <div class="col-lg-6">
        <div class="card h-100 card-hover reveal">
          <div class="card-body">
            <h3 class="h5 mb-3">De quoi avez-vous besoin ?</h3>
            <div class="vstack gap-2">
              <div class="check-item"><i class="bi bi-check-circle-fill"></i><span>Bouteille d‚Äôeau</span></div>
              <div class="check-item"><i class="bi bi-check-circle-fill"></i><span>Tenue adapt√©e</span></div>
              <div class="check-item"><i class="bi bi-check-circle-fill"></i><span>Chaussures de sport</span></div>
              <div class="check-item"><i class="bi bi-check-circle-fill"></i><span>Serviette</span></div>
              <div class="check-item"><i class="bi bi-check-circle-fill"></i><span>Et votre curiosit√© !</span></div>
            </div>
          </div>
          <div class="card-footer bg-transparent">
            <small class="text-muted">Besoin d‚Äôun conseil mat√©riel ? √âcrivez-nous.</small>
          </div>
        </div>
      </div>

    </div>

    <div class="text-center mt-5">
      <a href="#reserver" class="btn btn-primary btn-lg"><i class="bi bi-calendar-event me-2"></i>R√©server</a>
    </div>

  </div>
</section>

<section id="reserver" class="py-5">
  <div class="container">

    <h2 class="h1 text-center mb-2 reveal reveal-up">R√©servez votre s√©ance</h2>
    <p class="text-center text-muted mb-5">Choisissez un cr√©neau, dites-nous votre objectif, on s‚Äôoccupe du reste.</p>

    {# Bandeau pr√©-s√©lection #}
    {% set preTitle = app.request.query.get('title') %}
    {% set preStart = app.request.query.get('start') %}
    {% set preEnd   = app.request.query.get('end') %}
    {% set preDay   = app.request.query.get('day') %}

    {% if preTitle and preStart and preEnd %}
      {% set dayLabels = {
        'mon': 'lundi',
        'tue': 'mardi',
        'wed': 'mercredi',
        'thu': 'jeudi',
        'fri': 'vendredi',
        'sat': 'samedi',
        'sun': 'dimanche'
      } %}

      <div class="alert alert-info d-flex align-items-start gap-3 mb-4">
        <i class="bi bi-info-circle-fill fs-4"></i>
        <div>
          <strong>S√©ance pr√©-s√©lectionn√©e :</strong><br>
          {{ preTitle }}<br>
          {{ dayLabels[preDay] ?? '' }} ‚Ä¢ {{ preStart }} ‚Äì {{ preEnd }}<br>
          <small class="text-muted">Vous pouvez modifier la date ou le cr√©neau si besoin.</small>
        </div>
      </div>
    {% endif %}

    {{ form_start(form, { attr: { class: 'row g-3 g-lg-4', 'data-turbo': 'false' } }) }}

      <div class="col-md-6">{{ form_row(form.firstName) }}</div>
      <div class="col-md-6">{{ form_row(form.lastName) }}</div>
      <div class="col-md-6">{{ form_row(form.email) }}</div>
      <div class="col-md-6">{{ form_row(form.phone) }}</div>

      <div class="col-md-6">{{ form_row(form.goal) }}</div>

      <div class="col-md-4">{{ form_row(form.trialDate) }}</div>

      <div class="col-md-8">
        <div class="mb-3">
          <label for="trial-slot-select" class="form-label">Cr√©neau disponible</label>
          <select id="trial-slot-select" class="form-select js-trial-slot">
            <option value="">Choisissez d‚Äôabord une date</option>
          </select>

          {# Champ cach√© mapp√© Symfony (JSON du cr√©neau) #}
          {{ form_widget(form.trialSlot) }}

          {# Erreurs back-end sur trialSlot #}
          <div id="slot-error" class="invalid-feedback d-block">
            {{ form_errors(form.trialSlot) }}
          </div>
        </div>
      </div>

      <div class="col-12">{{ form_row(form.message) }}</div>

      <div class="col-12">
        <div class="alert alert-warning d-flex align-items-center gap-2 mb-2">
          <i class="bi bi-bell-fill text-warning"></i>
          <span><strong>Nous vous recontacterons pour confirmer le cr√©neau s√©lectionn√©.</strong></span>
        </div>
      </div>

      <div class="col-12 d-flex gap-2 align-items-center">
        {{ form_widget(form.send) }}
      </div>

      <div class="text-danger">
          {{ form_errors(form) }}
      </div>

    {{ form_end(form) }}

    {# donn√©es du planning #}
    <script id="week-events" type="application/json">
      {{ events|json_encode(constant('JSON_UNESCAPED_UNICODE'))|raw }}
    </script>

    <script>
(function(){

  // r√©cup√©ration JSON des √©v√©nements
  const el = document.getElementById('week-events');
  let WEEK_EVENTS = [];
  try { WEEK_EVENTS = JSON.parse(el?.textContent || '[]'); }
  catch(e){ console.error('Invalid WEEK_EVENTS JSON', e); WEEK_EVENTS = []; }

  const inputDate   = document.querySelector('.js-trial-date');
  const selectSlot  = document.querySelector('.js-trial-slot');
  const hiddenSlot  = document.getElementById('trial_request_trialSlot');
  const slotError   = document.getElementById('slot-error');
  const formEl      = document.querySelector('form[name="trial_request"]');

  if (!inputDate || !selectSlot || !hiddenSlot || !formEl) return;

  const JS2KEY = ['sun','mon','tue','wed','thu','fri','sat'];
  const KEY2JS = { sun:0, mon:1, tue:2, wed:3, thu:4, fri:5, sat:6 };

  function dayKeyFromISO(iso){
    if (!iso) return null;
    const [y,m,d] = iso.split('-').map(Number);
    const date = new Date(y, m-1, d);
    if (isNaN(date)) return null;
    return JS2KEY[date.getDay()];
  }

  // üîÅ Prochain jour STRICTEMENT FUTUR (si on est jeudi et qu‚Äôon choisit "thu" ‚Üí jeudi prochain)
  function nextDateForDayKey(dayKey){
    const target = KEY2JS[dayKey];
    if (target === undefined) return null;

    const today = new Date();
    const d = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const cur = d.getDay();

    let diff = target - cur;
    if (diff <= 0) diff += 7;   // <= 0 -> toujours la semaine SUIVANTE

    d.setDate(d.getDate() + diff);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function norm(s){
    return (s || '')
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g,'')
      .toUpperCase()
      .replace(/[^A-Z0-9]/g,'');
  }

  function setOptions(items){
    selectSlot.innerHTML = '';
    selectSlot.classList.remove('is-invalid');
    if (slotError) slotError.textContent = '';

    if (!items.length){
      const opt = new Option('Aucun cr√©neau ce jour-l√†', '', true, true);
      opt.disabled = true;
      selectSlot.add(opt);
      hiddenSlot.value = '';
      return;
    }

    selectSlot.add(new Option('Choisissez un cr√©neau‚Ä¶',''));
    items.forEach(it => selectSlot.add(new Option(it.label, it.value)));
    hiddenSlot.value = '';
  }

  // param√®tres URL (planning)
  const params    = new URLSearchParams(window.location.search);
  const preTitle  = params.get('title');
  const preStart  = params.get('start');
  const preEnd    = params.get('end');
  const preDayKey = params.get('day');

  let autoApplied = false;

  function onDateChange(){
    const iso = inputDate.value;
    const key = dayKeyFromISO(iso);
    if (!key){ setOptions([]); return; }

    const slots = WEEK_EVENTS
      .filter(ev => ev.day === key)
      .sort((a,b)=> a.start.localeCompare(b.start))
      .map(ev => ({
        label: `${ev.start} ‚Äì ${ev.end} ‚Ä¢ ${ev.title}`,
        value: JSON.stringify({
          day:   key,
          start: ev.start,
          end:   ev.end,
          title: ev.title,
          type:  ev.type || null
        })
      }));

    setOptions(slots);

    // pr√©-s√©lection automatique seulement une fois
    if (!autoApplied && (preTitle || preStart)){
      const wantedTitle = norm(preTitle);
      const wantedStart = preStart;

      const options = Array.from(selectSlot.options).slice(1);
      let index = -1;

      options.forEach((o,i)=>{
        try{
          const v = JSON.parse(o.value);
          const matchStart = wantedStart && v.start === wantedStart;
          const matchTitle = wantedTitle && norm(v.title).includes(wantedTitle);

          if (matchStart && matchTitle && index === -1){
            index = i+1;
          }
        }catch(e){}
      });

      if (index > 0){
        selectSlot.selectedIndex = index;
        hiddenSlot.value = selectSlot.value;
        autoApplied = true;
      }
    }
  }

  // üîπ ICI : on force la date si on vient du planning, m√™me si une valeur existe d√©j√†
  if (preDayKey){
    const iso = nextDateForDayKey(preDayKey);
    if (iso) {
      inputDate.value = iso;
    }
  }

  // init slots
  if (inputDate.value){
    onDateChange();
  }

  inputDate.addEventListener('change', onDateChange);

  selectSlot.addEventListener('change', ()=>{
    hiddenSlot.value = selectSlot.value || '';
    if (hiddenSlot.value){
      selectSlot.classList.remove('is-invalid');
      if (slotError) slotError.textContent = '';
    }
  });

  // synchro finale avant soumission
  formEl.addEventListener('submit', ()=>{
    if (selectSlot.value && !hiddenSlot.value){
      hiddenSlot.value = selectSlot.value;
    }
  });

})();
    </script>


  </div>
</section>

{% endblock %}
